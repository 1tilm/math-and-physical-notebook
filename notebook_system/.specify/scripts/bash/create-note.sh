#!/usr/bin/env bash
# å­¦æœ¯ç¬”è®°åˆ›å»ºè„šæœ¬ - ä¸“é—¨ä¸ºå­¦æœ¯ç¬”è®°ç³»ç»Ÿè®¾è®¡

set -e

# è§£æå‘½ä»¤è¡Œå‚æ•°
SUBJECT=""
TOPIC=""
JSON_MODE=false

for arg in "$@"; do
    case "$arg" in
        --json)
            JSON_MODE=true
            ;;
        --help|-h)
            cat << 'EOF'
ç”¨æ³•: create-note.sh <å­¦ç§‘> <ä¸»é¢˜> [--json]

åˆ›å»ºæ–°çš„å­¦æœ¯ç¬”è®°ï¼ŒåŒ…å«å®Œæ•´çš„ç›®å½•ç»“æ„å’Œæ¨¡æ¿æ–‡ä»¶ã€‚

å‚æ•°:
  å­¦ç§‘        ç¬”è®°æ‰€å±å­¦ç§‘ (å¦‚: æ•°å­¦, ç‰©ç†, è®¡ç®—æœº)
  ä¸»é¢˜        ç¬”è®°ä¸»é¢˜ (å¦‚: çº¿æ€§ä»£æ•°, ç”µç£å­¦, æ•°æ®ç»“æ„)
  --json      ä»¥JSONæ ¼å¼è¾“å‡ºç»“æœ
  --help      æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

ç¤ºä¾‹:
  ./create-note.sh æ•°å­¦ çº¿æ€§ä»£æ•°
  ./create-note.sh ç‰©ç† ç”µç£å­¦ --json

è¾“å‡º:
  åˆ›å»ºç¬”è®°æ–‡ä»¶: notes/æ•°å­¦/çº¿æ€§ä»£æ•°è¯¦è§£.md
  åˆ›å»ºè§„æ ¼ç›®å½•: specs/æ•°å­¦-çº¿æ€§ä»£æ•°/
EOF
            exit 0
            ;;
        *)
            if [[ -z "$SUBJECT" ]]; then
                SUBJECT="$arg"
            elif [[ -z "$TOPIC" ]]; then
                TOPIC="$arg"
            else
                echo "é”™è¯¯: æœªçŸ¥å‚æ•° '$arg'" >&2
                echo "ä½¿ç”¨ --help æŸ¥çœ‹ç”¨æ³•" >&2
                exit 1
            fi
            ;;
    esac
done

# éªŒè¯å¿…éœ€å‚æ•°
if [[ -z "$SUBJECT" || -z "$TOPIC" ]]; then
    echo "é”™è¯¯: å¿…é¡»æä¾›å­¦ç§‘å’Œä¸»é¢˜å‚æ•°" >&2
    echo "ç”¨æ³•: $0 <å­¦ç§‘> <ä¸»é¢˜> [--json]" >&2
    echo "ç¤ºä¾‹: $0 æ•°å­¦ çº¿æ€§ä»£æ•°" >&2
    exit 1
fi

# è·å–è„šæœ¬ç›®å½•å’Œé€šç”¨å‡½æ•°
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common.sh"

# è·å–ä»“åº“æ ¹ç›®å½•
REPO_ROOT=$(get_repo_root)

# å®šä¹‰ç›®å½•å’Œæ–‡ä»¶è·¯å¾„
NOTE_DIR="$REPO_ROOT/notes/$SUBJECT"
NOTE_FILE="$NOTE_DIR/${TOPIC}è¯¦è§£.md"
SPEC_DIR="$REPO_ROOT/specs/$SUBJECT-$TOPIC"

# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p "$NOTE_DIR"
mkdir -p "$SPEC_DIR/contracts"
mkdir -p "$REPO_ROOT/å›¾ç‰‡èµ„æº/é”™é¢˜å›¾ç‰‡"
mkdir -p "$REPO_ROOT/å›¾ç‰‡èµ„æº/è§£ç­”å›¾ç‰‡"

# æ£€æŸ¥ç¬”è®°æ¨¡æ¿
NOTE_TEMPLATE="$REPO_ROOT/.specify/templates/note-template.md"
if [[ ! -f "$NOTE_TEMPLATE" ]]; then
    echo "è­¦å‘Š: ç¬”è®°æ¨¡æ¿ä¸å­˜åœ¨ï¼Œåˆ›å»ºåŸºç¡€æ¨¡æ¿..." >&2
    cat > "$NOTE_TEMPLATE" << 'EOF'
# [ä¸»é¢˜åç§°]è¯¦è§£

**è¯¾ç¨‹æ¥æº**: [è¯¾ç¨‹åç§°]  
**æˆè¯¾æ•™å¸ˆ**: [æ•™å¸ˆå§“å]  
**å­¦æ ¡**: [å­¦æ ¡åç§°]

## ğŸ“Š çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root(([ä¸»é¢˜åç§°]))
    åŸºæœ¬æ¦‚å¿µ
      å®šä¹‰
      ç‰¹å¾
      æ¡ä»¶
    æ ¸å¿ƒå†…å®¹
      ç†è®º1
      ç†è®º2
      åº”ç”¨
    å®é™…åº”ç”¨
      åº”ç”¨1
      åº”ç”¨2
      æ¡ˆä¾‹
```

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬æ¦‚å¿µ

### 1.1 å®šä¹‰

### 1.2 åŸºæœ¬æ€§è´¨

## ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¸å¿ƒç†è®º

### 2.1 ç†è®ºåŸºç¡€

### 2.2 é‡è¦å…¬å¼

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®é™…åº”ç”¨

### 3.1 åº”ç”¨é¢†åŸŸ

### 3.2 å…¸å‹æ¡ˆä¾‹

---

## ğŸ“– è€ƒè¯•å®å…¸

### ğŸ”¥ é«˜é¢‘è€ƒç‚¹æ€»ç»“

### âš¡ å¿«é€Ÿè§£é¢˜æŠ€å·§

### ğŸ¯ æ ‡å‡†ç­”é¢˜æ¨¡æ¿

---

## âš ï¸ æ˜“é”™ç‚¹æ•°æ®åº“

### ğŸš¨ æ¦‚å¿µç±»æ˜“é”™ç‚¹

### ğŸš¨ è®¡ç®—ç±»æ˜“é”™ç‚¹

---

## ğŸ“‹ é€ŸæŸ¥æ‰‹å†Œ

### ğŸ”§ æ ¸å¿ƒå…¬å¼é€ŸæŸ¥è¡¨

### ğŸ”¢ å¸¸ç”¨æ•°å€¼é€ŸæŸ¥è¡¨

---

## ğŸ’ª åˆ†å±‚æ¬¡ä¾‹é¢˜ä½“ç³»

### ğŸŸ¢ ç¬¬ä¸€å±‚ï¼šåŸºç¡€ç†è§£é¢˜

### ğŸŸ¡ ç¬¬äºŒå±‚ï¼šåº”ç”¨è®¡ç®—é¢˜

### ğŸ”´ ç¬¬ä¸‰å±‚ï¼šç»¼åˆåˆ†æé¢˜

---

## ğŸ† è€ƒè¯•å†²åˆºè¦ç‚¹

### å¿…èƒŒå…¬å¼

### å…³é”®æ¦‚å¿µ

### è§£é¢˜æŠ€å·§

---

## æ€»ç»“

[çŸ¥è¯†ç‚¹æ€»ç»“å’Œå­¦ä¹ å»ºè®®]
EOF
fi

# ä»æ¨¡æ¿åˆ›å»ºç¬”è®°æ–‡ä»¶
cp "$NOTE_TEMPLATE" "$NOTE_FILE"
sed -i "s/\[ä¸»é¢˜åç§°\]/$TOPIC/g" "$NOTE_FILE"
sed -i "s/\[è¯¾ç¨‹åç§°\]/$SUBJECT/g" "$NOTE_FILE"

# åˆ›å»ºè§„æ ¼è¯´æ˜æ–‡ä»¶
SPEC_TEMPLATE="$REPO_ROOT/.specify/templates/spec-template.md"
PLAN_TEMPLATE="$REPO_ROOT/.specify/templates/plan-template.md"

if [[ -f "$SPEC_TEMPLATE" ]]; then
    cp "$SPEC_TEMPLATE" "$SPEC_DIR/spec.md"
    sed -i "s/\[FEATURE NAME\]/$SUBJECT-$TOPIC å­¦æœ¯ç¬”è®°/g" "$SPEC_DIR/spec.md"
    sed -i "s/\[###-feature-name\]/$SUBJECT-$TOPIC/g" "$SPEC_DIR/spec.md"
fi

if [[ -f "$PLAN_TEMPLATE" ]]; then
    cp "$PLAN_TEMPLATE" "$SPEC_DIR/plan.md"
    sed -i "s/\[FEATURE\]/$SUBJECT-$TOPIC å­¦æœ¯ç¬”è®°/g" "$SPEC_DIR/plan.md"
    sed -i "s/\[###-feature-name\]/$SUBJECT-$TOPIC/g" "$SPEC_DIR/plan.md"
fi

# åˆ›å»ºå­¦æœ¯ç¬”è®°ä¸“ç”¨çš„æ•°æ®æ¨¡å‹æ–‡ä»¶
cat > "$SPEC_DIR/data-model.md" << EOF
# æ•°æ®æ¨¡å‹: $SUBJECT-$TOPIC å­¦æœ¯ç¬”è®°

## ç¬”è®°ç»“æ„æ¨¡å‹

### æ ¸å¿ƒå®ä½“

#### Note (ç¬”è®°)
- **æ ‡é¢˜**: $TOPICè¯¦è§£
- **å­¦ç§‘**: $SUBJECT
- **åˆ›å»ºæ—¥æœŸ**: $(date +%Y-%m-%d)
- **çŠ¶æ€**: è‰ç¨¿/å®Œæˆ/éœ€è¦æ›´æ–°

#### Section (ç« èŠ‚)
- **ç« èŠ‚ç¼–å·**: 1.1, 1.2, 2.1, etc.
- **ç« èŠ‚æ ‡é¢˜**: å…·ä½“ç« èŠ‚åç§°
- **å†…å®¹ç±»å‹**: æ¦‚å¿µ/ç†è®º/åº”ç”¨/ä¾‹é¢˜

#### ErrorRecord (é”™é¢˜è®°å½•)
- **é”™é¢˜ç¼–å·**: YYYYMMDD_å­¦ç§‘_åºå·
- **é”™è¯¯ç±»å‹**: æ¦‚å¿µæ€§/è®¡ç®—æ€§/æ–¹æ³•æ€§/åº”ç”¨æ€§
- **å…³è”çŸ¥è¯†ç‚¹**: ç›¸å…³ç« èŠ‚å’Œæ¦‚å¿µ
- **æ•´åˆçŠ¶æ€**: å¾…å¤„ç†/å·²æ•´åˆ/éœ€è¦å¤æŸ¥

#### Formula (å…¬å¼)
- **å…¬å¼ç¼–å·**: æŒ‰ç« èŠ‚ç¼–å·
- **å…¬å¼å†…å®¹**: LaTeXæ ¼å¼
- **é€‚ç”¨æ¡ä»¶**: ä½¿ç”¨å‰æå’Œé™åˆ¶
- **ç›¸å…³ä¾‹é¢˜**: å…³è”çš„ä¾‹é¢˜ç¼–å·

### å…³ç³»æ¨¡å‹

- Note 1:N Section (ä¸€ä¸ªç¬”è®°åŒ…å«å¤šä¸ªç« èŠ‚)
- Section 1:N Formula (ä¸€ä¸ªç« èŠ‚åŒ…å«å¤šä¸ªå…¬å¼)
- Section 1:N ErrorRecord (ä¸€ä¸ªç« èŠ‚å…³è”å¤šä¸ªé”™é¢˜)
- ErrorRecord M:N Formula (é”™é¢˜å¯èƒ½æ¶‰åŠå¤šä¸ªå…¬å¼)

### è´¨é‡æŒ‡æ ‡

- **å®Œæ•´æ€§**: å¿…å¤‡ç« èŠ‚æ˜¯å¦é½å…¨
- **å‡†ç¡®æ€§**: å…¬å¼å’Œæ¦‚å¿µæ˜¯å¦æ­£ç¡®
- **å®ç”¨æ€§**: è€ƒè¯•å®å…¸å’Œé€ŸæŸ¥æ‰‹å†Œæ˜¯å¦æœ‰æ•ˆ
- **æ›´æ–°é¢‘ç‡**: é”™é¢˜æ•´åˆå’Œå†…å®¹æ›´æ–°é¢‘ç‡
EOF

# è¾“å‡ºç»“æœ
if $JSON_MODE; then
    printf '{"note_file":"%s","spec_dir":"%s","subject":"%s","topic":"%s","status":"created"}\n' \
        "$NOTE_FILE" "$SPEC_DIR" "$SUBJECT" "$TOPIC"
else
    echo "âœ… å­¦æœ¯ç¬”è®°åˆ›å»ºæˆåŠŸ!"
    echo "ğŸ“ ç¬”è®°æ–‡ä»¶: $NOTE_FILE"
    echo "ğŸ“‹ è§„æ ¼ç›®å½•: $SPEC_DIR"
    echo "ğŸ¯ å­¦ç§‘: $SUBJECT"
    echo "ğŸ“š ä¸»é¢˜: $TOPIC"
    echo ""
    echo "ğŸ“– ä¸‹ä¸€æ­¥æ“ä½œ:"
    echo "1. ç¼–è¾‘ç¬”è®°å†…å®¹: $NOTE_FILE"
    echo "2. ä½¿ç”¨ /speckit.plan å‘½ä»¤è§„åˆ’ç¬”è®°å†…å®¹"
    echo "3. ä½¿ç”¨ /speckit.tasks å‘½ä»¤åˆ†è§£ä»»åŠ¡"
    echo "4. ä½¿ç”¨ /speckit.implement å‘½ä»¤è‡ªåŠ¨åŒ–å®æ–½"
fi
